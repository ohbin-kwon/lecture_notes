## 입출력 IO에서, 다른 언어와 비교했을때, nodejs가 비동기 처리 방식 통해서 얻을 수 있는 이점은?

nodejs는 단일 스레드로 이루어져있고, non-blocking IO그러니까, 입력과 출력 작업을 비동기로 처리한다는 이야기를 많이 들으셨을 것이다. 그런데 이게 대체 왜 좋은지 우리는 모르기때문에, 그냥 좋은가보다 하고 쓴다.
하지만, 어떤 배경에서 단일 스레드와 비동기IO 처리가 등장했고, 이게 왜 좋은지 이해한다면, 우리는 좀더 nodejs의 매커니즘을 파악하고, 이를 이용하기에 수월할 것이다.

그래서 먼저 우리는 어떤 배경에서 nodejs가 등장했으며, nodejs가 어떤 환경에서 사용하기 좋은지 알아보고, nodejs를 어떻게 사용하면 좋을지에 대해 이야기해보고자 한다.

개발자가 프로그래밍을 하며 가장 중요한것은 무엇일까? 뭐가 가장 중요한지는 상황에 따라 다를 것이다. 그렇지만 본능적으로 신경쓰는 부분은 존재한다. 바로 속도이다. 내가만든 프로그램이나 웹페이지의 로딩화면이 길어지면 이거 클라이언트가 화나겠는데 하고 불안해진다. 
과거에 하드웨어 또는 소프트웨어를 만들던 사람들도 마찬가지였다. 그들이 만들어낸 마스터피스들의 사용자가 좀더 빠른 응답을 받고 만족하길 원했다. 하드웨어 개발자들은 cpu나 메모리 등의 성능을 높이거나, 캐시를 이용해 cpu 내부버스를 사용하도록 하거나, 저장 장치의 계층구조를 만들었다. 소프트웨어 개발자들 또한 운영체제를 만들때 folk, exec등을 이용해 프로세스를 효율적으로 사용하도록 했고, 하드웨어의 발전(다중 cpu의 등장)에 따라 프로세스를 스레드로 나누며 멀티스레드가 등장하게 되었다.
(1. 멀티스레드가 등장한 것은 프로세스를 좀더 세분화해서 여러 cpu가 하나의 프로세스를 좀더 세분화해서 효율적으로 작업을 하기 위함이다.)
(2. 멀티스레드에 대해 자세히 이해하려면, 시분할 시스템, cpu스케줄링, context switching, timeout 등의 cpu가 어떻게 프로세스 또는 스레드를 처리하는지에 대해 알아야한다. 이런 개념은 굉장히 중요하지만, 추후에 공부하시리라 믿고, 멀티스레드에 대해 설명하겠다.)

위의 글을 읽어보면 소프트웨어 개발자들이 운영체제를 만들었다고 했다. 우리는 소프트웨어를 단지 word, 게임 또는 각종 프로그래밍 언어로 만든 것이라 생각하는데, 사실 운영체제 또한 소프트웨어이다. 운영체제는 일반적인 소프트웨어 보다 하드웨어에 접근권한을 가지는 소프트웨어이다.(좀더 알고 싶다면, 운영체제에 대해 공부해보자, 커널 스레드, 시스템 호출, 메모리 관리 등 재미있는 부분이 많다.)
그렇다면 운영체제에서 스레드를 사용한것처럼 프로그래밍 언어를 이용해 스레드를 구현하고 사용할 수 있음을 뜻한다. 멀티스레드를 도입한 대표적인 언어가 바로 JAVA이다.

java와 멀티스레드에 대해 이야기하기전에, 우리는 IO와 cpu의 작업에 대해 먼저 알아야한다. IO란 input/output을 뜻하며, 단순히 마우스, 모니터와 같은 입출력 장치뿐만아니라, ram, 하드디스크, database, network 같은 모든 입출력을 뜻한다.
cpu는 한번에 한작업밖에 하지 못한다. 그래서 우리는 cpu를 효율적으로 사용해야한다. 연산과 같은 cpu의 리소스를 많이 이용하는 프로세스는 연산의 복잡도를 줄여야 하는데 멀티스레드와 관련이 없으니 넘어가겠다. 문제는 cpu를 많이 이용하지 않더라도 blocking(IO의 응답을 기다리며 해당 스레드를 실행하지않는것, 대기큐, 동기화)되어 cpu가 유휴시간을 가질때 발생한다. 이런 유휴시간을 어떻게 줄일 수 있을까?(이와관련해서 프로세스를 처리하는 다른 개념도 있지만 멀티스레드에 대해서만 설명하겠다.) java는 IO의 유휴시간을 줄이기 위해 멀티스레드를 이용한다. 프로세스를 여러개의 스레드를 시분할시스템(간단히 설명하자면, cpu스케줄러가 스레드를 대기큐, 준비큐의 우선순위를 이용해 cpu 이용 순서를 정하고, timeslice에 따라 constext switching하는것, 순서는 cpu 스케줄러에 의존하므로 스레드의 순서를 특정할수 없음)으로 작동해, 특정 스레드에 IO요청이 있어 blocking되더라도, blocking되지않은 스레드를 cpu가 처리하게 한다. 이를 병렬 처리라고한다.(한 프로세스 안의 스레드는 긴밀히 연결되어있다던가, 스레드의 공유자원 관리를 신경써야한다던가 이런 부분을 주의해야한다.)

그렇다면 이러한 병렬처리의 단점은 무엇일까? 스레드가 많이 생길때 문제가 발생한다. 만약 클라이언트가 요청을 할때마다 스레드를 만들도록 했다면, 컴퓨터의 자원은 한정적이기에 스레드를 생성할 수 있는 한계(메모리 부족)가 존재할 것이며, context switching할때 오버헤드도 늘어날 것입니다. 즉 메모리와 cpu 사이클 낭비를 유발 할 수 있다.
이러한 문제점을 해결하기위해 nodejs가 등장했다. nodejs는 단 하나의 스레드를 이용해 모든 작업을 처리한다(실제로는 여러 스레드가 존재하지만, 이는 suppotring용이며 개발자는 메인스레드만을 이용한다) 그렇다면 IO가 발생할때 nodejs는 어떻게 처리할까? 

먼저 운영체제가 기본적으로 제공하는 non-blocking IO는 응답하려는 결과가 있다면 그 값을 반환하지만, 없을때는 기다리지 않고 빈값을 반환한다. 그리고 busy-waiting(값이 있는지 없는지를 매번확인하는것)을 실행해 값이 들어온것을 확인했을때, 그값을 반환한다. busy-waiting을 한다면 루프가 발생하고 이는 cpu낭비로 이어진다.
nodejs 서버에서는 busy-wating을 사용하지 않고도, IO작업을 event를 활용해 비동기로 효율적으로 처리할 수 있다. (이에 대한 자세한 내용은 다음장에서 설명하겠다.)  또한 먼저 끝난 작업을 요청한 순서에 상관없이 처리할 수 있다는것도 이점이다. 멀티스레드가 작업을 스레드에 분리했다면, nodejs는 작업을 시간에 따라 분리한다. 이를 동시성이라고하며 병렬처리와 비슷해보이지만 다르다. 이렇게 동시성처리를 이용해 다중스레드가 가지는 문제인 race condition 발생문제와 다중스레드의 동기화문제 또한 해결할 수 있다.


이러한 단일스레드 비동기IO처리의 단점도 분명히 존재한다. 하나의 작업을 스레드로 나눌 수 없기에, cpu집중적인 작업을 하나의 스레드에서 처리해야한다. 이때문에 cpu집중 작업이 많은 웹서버에서는 적합하지 않다. 다른 장단점을 확인하고 싶다면 아래 주소를 참조하자.
nodejs 장단점: https://www.simform.com/blog/nodejs-advantages-disadvantages/

참조:
 - nodejs 디자인패턴 바이블(영진닷컴)
 - 쉽게배우는 운영체제(한빛 아카데미)
 - operatring concepts(퍼스트북)
 - https://www.simform.com/blog/nodejs-advantages-disadvantages/
 - https://relevant.software/blog/7-benefits-of-node-js-for-startups/

글쓴이: ohbin-kwon
